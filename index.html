<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Comparador profesional de tarifas el√©ctricas. Encuentra la luz m√°s barata en segundos seg√∫n tus consumos espec√≠ficos." />
  <meta name="keywords" content="tarifas electricidad, comparador luz, tarifa fija, precio electricidad, contrataci√≥n luz" />
  <meta name="theme-color" content="#8B5CF6" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Comparador Tarifas" />
  
  <!-- Open Graph -->
  <meta property="og:title" content="Comparador de Tarifas El√©ctricas | Encuentra la Luz M√°s Barata" />
  <meta property="og:description" content="Compara tarifas de electricidad en tiempo real. Encuentra la oferta m√°s barata seg√∫n tus consumos espec√≠ficos. Sin registro, sin publicidad." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://luzfija.es/" />
  <meta property="og:locale" content="es_ES" />
  
  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Comparador de Tarifas El√©ctricas" />
  <meta name="twitter:description" content="Encuentra tu tarifa de luz m√°s barata en segundos" />
  
  <!-- Canonical -->
  <link rel="canonical" href="https://luzfija.es/" />
  
  <!-- Prefetch/Preconnect -->
  <link rel="dns-prefetch" href="https://fonts.googleapis.com" />
  <link rel="dns-prefetch" href="https://script.google.com" />
  <link rel="dns-prefetch" href="https://static.cloudflareinsights.com" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link rel="preload"
        href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap"
        as="style">

  <link rel="preload" href="tarifas.json" as="fetch" crossorigin="anonymous">

  <title>‚ö° Comparador de Tarifas El√©ctricas</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
  <link rel="icon" type="image/png" sizes="48x48" href="favicon.png">
  <link rel="icon" type="image/svg+xml" href="favicon.svg">
  <link rel="apple-touch-icon" sizes="180x180" href="favicon.png">

  <!-- Schema Markup (JSON-LD) -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebApplication",
    "name": "Comparador de Tarifas El√©ctricas",
    "description": "Herramienta profesional para comparar tarifas de electricidad en Espa√±a. Encuentra la oferta m√°s barata seg√∫n tus consumos espec√≠ficos.",
    "url": "https://luzfija.es",
    "applicationCategory": "UtilitiesApplication",
    "operatingSystem": "Any",
    "inLanguage": "es",
    "offers": {
      "@type": "Offer",
      "price": "0",
      "priceCurrency": "EUR"
    },
    "creator": {
      "@type": "Person",
      "name": "aLMaX"
    }
  }
  </script>

  <style>
    /* === TU DISE√ëO ORIGINAL EXACTO (NO TOCAR) === */
    :root{ --bg0:#070A12; --bg1:#0B1020; --card: rgba(255,255,255,.06); --card2: rgba(255,255,255,.085); --border: rgba(255,255,255,.10); --border2: rgba(255,255,255,.16); --text:#F7F7FB; --muted: rgba(247,247,251,.72); --muted2: rgba(247,247,251,.55); --accent:#8B5CF6; --accent2:#22C55E; --warn:#F59E0B; --danger:#EF4444; --shadow: 0 22px 65px rgba(0,0,0,.52); --shadow2: 0 16px 40px rgba(0,0,0,.50); --radius: 18px; --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; --sans: 'Outfit', ui-sans-serif, system-ui, -apple-system, sans-serif; }
    *{box-sizing:border-box; margin:0; padding:0}
    html,body{height:100%;}
    body{ font-family: var(--sans); color: var(--text); background: radial-gradient(1000px 600px at 12% 15%, rgba(139,92,246,.22), transparent 55%), radial-gradient(1000px 680px at 86% 88%, rgba(34,197,94,.16), transparent 55%), linear-gradient(135deg, var(--bg0), var(--bg1)); overflow-x:hidden; }
    .container{ max-width:1400px; margin:0 auto; padding: clamp(50px, 5vw, 70px) clamp(22px, 4.5vw, 60px); }
    .topbar{ display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom: 22px; flex-wrap: wrap; }
    @media (max-width: 520px){ .topbar{ justify-content: center; } }
    .brand{display:flex; align-items:center; gap:14px; min-width: 240px; position: relative; flex-shrink: 0;}
    @media (max-width: 520px){ .brand{ min-width: auto; } }
    .logo{ width:60px; height:60px; border-radius:18px; background: linear-gradient(135deg, #667eea 0%, #764ba2 25%, #f093fb 50%, #4facfe 75%, #00f2fe 100%); background-size: 400% 400%; box-shadow: 0 0 30px rgba(139,92,246,.4), 0 0 60px rgba(139,92,246,.2), 0 10px 40px rgba(0,0,0,.3), inset 0 0 20px rgba(255,255,255,.1); display:grid; place-items:center; font-size: 32px; position: relative; overflow: visible; animation: gradientShift 8s ease infinite, logoFloat 3s ease-in-out infinite; border: 2px solid rgba(255,255,255,.2); backdrop-filter: blur(10px); flex-shrink: 0; }
    .logo::before{ content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,.8) 50%, transparent 70%); animation: logoRotate 3s linear infinite; }
    .logo::after{ content: ''; position: absolute; top: -4px; left: -4px; right: -4px; bottom: -4px; border-radius: 20px; border: 2px solid transparent; background: linear-gradient(45deg, #667eea, #764ba2, #f093fb, #4facfe) border-box; -webkit-mask: linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0); -webkit-mask-composite: xor; mask-composite: exclude; animation: ringPulse 2s ease-in-out infinite; opacity: 0.6; }
    @keyframes gradientShift { 0%, 100% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } }
    @keyframes logoFloat { 0%, 100% { transform: translateY(0) rotate(0deg); } 25% { transform: translateY(-5px) rotate(-2deg); } 50% { transform: translateY(0) rotate(0deg); } 75% { transform: translateY(-5px) rotate(2deg); } }
    @keyframes logoRotate { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    @keyframes ringPulse { 0%, 100% { transform: scale(1); opacity: 0.6; } 50% { transform: scale(1.1); opacity: 1; } }
    .logo:hover{ transform: scale(1.15) rotate(5deg) !important; box-shadow: 0 0 50px rgba(139,92,246,.6), 0 0 100px rgba(139,92,246,.3), 0 15px 50px rgba(0,0,0,.4); }
    .particle{ position: absolute; width: 4px; height: 4px; background: linear-gradient(45deg, var(--accent), var(--accent2)); border-radius: 50%; pointer-events: none; opacity: 0; animation: particleFloat 3s ease-in-out infinite; box-shadow: 0 0 10px currentColor; }
    .particle:nth-child(1) { top: 10px; left: -20px; animation-delay: 0s; } .particle:nth-child(2) { top: 40px; left: -15px; animation-delay: 0.5s; } .particle:nth-child(3) { top: 25px; left: 80px; animation-delay: 1s; } .particle:nth-child(4) { top: 5px; left: 75px; animation-delay: 1.5s; } .particle:nth-child(5) { top: 50px; left: 70px; animation-delay: 2s; } .particle:nth-child(6) { top: -5px; left: 30px; animation-delay: 2.5s; }
    @keyframes particleFloat { 0% { opacity: 0; transform: translateY(0) scale(0); } 20% { opacity: 1; transform: translateY(-10px) scale(1); } 80% { opacity: 1; transform: translateY(-30px) scale(0.8); } 100% { opacity: 0; transform: translateY(-50px) scale(0); } }
    .brand h1{ font-size: clamp(20px,3.2vw,34px); line-height: 1.05; letter-spacing: -0.5px; font-weight: 900; background: linear-gradient( 90deg, rgba(167,139,250,1) 0%, rgba(139,92,246,1) 25%, rgba(34,197,94,1) 50%, rgba(139,92,246,1) 75%, rgba(167,139,250,1) 100% ); background-size: 200% auto; -webkit-background-clip: text; background-clip:text; -webkit-text-fill-color: transparent; animation: shimmer 3s linear infinite; text-shadow: 0 0 30px rgba(139,92,246,.3); }
    @keyframes shimmer { 0% { background-position: 0% center; } 100% { background-position: 200% center; } }
    @keyframes ripple { from { transform: scale(0); opacity: 1; } to { transform: scale(4); opacity: 0; } }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes goldenPulse { 0%, 100% { box-shadow: 0 0 20px rgba(251, 191, 36, .3), 0 0 40px rgba(251, 191, 36, .1); } 50% { box-shadow: 0 0 30px rgba(251, 191, 36, .6), 0 0 60px rgba(251, 191, 36, .2); } }
    .brand p{color: var(--muted); font-size: 13px; margin-top: 3px;}
    .actions{display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end; flex-shrink: 0;}
    @media (max-width: 520px){ .actions{ justify-content: center; width: 100%; } }
    .pill{ display:flex; align-items:center; gap:10px; padding: 10px 14px; background: var(--card); border: 1px solid var(--border); border-radius: 999px; backdrop-filter: blur(14px); box-shadow: 0 12px 50px rgba(0,0,0,.20); color: var(--muted); font-size: 13px; user-select:none; white-space: nowrap; }
    .pill.loading{border-color: rgba(139,92,246,.55); box-shadow: 0 0 0 4px rgba(139,92,246,.12), 0 18px 55px rgba(0,0,0,.35);}
    .pill.ok{border-color: rgba(34,197,94,.55); box-shadow: 0 0 0 4px rgba(34,197,94,.12), 0 18px 55px rgba(0,0,0,.35);}
    .pill.err{border-color: rgba(239,68,68,.55); box-shadow: 0 0 0 4px rgba(239,68,68,.12), 0 18px 55px rgba(0,0,0,.35);}
    .btn{ border: 1px solid var(--border); background: var(--card); color: var(--text); padding: 10px 12px; border-radius: 12px; cursor:pointer; font-weight: 900; font-size: 13px; display:inline-flex; align-items:center; gap: 10px; transition: transform .15s ease, background .15s ease, border-color .15s ease, opacity .15s ease; backdrop-filter: blur(14px); min-height: 44px; }
    .btn:hover{transform: translateY(-1px); border-color: var(--border2); background: var(--card2);}
    .btn:active{transform: translateY(0px); opacity:.9}
    .btn.primary{ background: linear-gradient(45deg, rgba(139,92,246,1), rgba(167,139,250,1)); border-color: rgba(139,92,246,.55); box-shadow: 0 12px 30px rgba(139,92,246,.25); padding: 12px 14px; position: relative; overflow: hidden; }
    .btn.primary::before{ content: ''; position: absolute; bottom: 0; left: 0; height: 3px; width: 0%; background: linear-gradient(90deg, #22C55E, #10B981); box-shadow: 0 0 10px rgba(34,197,94,.6); transition: width 0.3s ease; }
    .btn.primary.calculating::before{ animation: progressBar 2s ease-in-out; }
    @keyframes progressBar { 0% { width: 0%; } 50% { width: 70%; } 100% { width: 100%; } }
    .btn.primary:disabled{ background: rgba(255,255,255,.06); border-color: var(--border); box-shadow:none; cursor:not-allowed; opacity:.6; transform:none; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .spinner{ display:inline-block; width:16px; height:16px; border:2px solid rgba(255,255,255,.3); border-top-color: #fff; border-radius:50%; animation: spin 0.6s linear infinite; }
    .grid{ display:grid; grid-template-columns: 420px 1fr; gap: 24px; }
    @media (max-width: 1100px){ .grid{grid-template-columns:1fr;} }
    .card{ background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); overflow:hidden; backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px); transition: transform .3s ease, box-shadow .3s ease; animation: fadeInUp 0.5s ease-out; margin-bottom: 6px; }
    .card:hover{ transform: translateY(-4px) translateZ(0); box-shadow: 0 28px 80px rgba(0,0,0,.60); }
    .card .head{ padding: 18px 18px 14px 18px; border-bottom: 1px solid var(--border); background: linear-gradient(180deg, rgba(139,92,246,.10), transparent); }
    .kicker{ font-size: 11px; letter-spacing: 1.2px; text-transform: uppercase; color: var(--muted2); font-weight: 900; }
    .title{ margin-top: 6px; font-size: 18px; font-weight: 900; letter-spacing: -0.3px; }
    .body{padding: 18px;}
    .alert{ border: 1px solid rgba(239,68,68,.40); background: rgba(239,68,68,.15); color: rgba(255,255,255,.95); padding: 12px 12px; border-radius: 14px; font-size: 13px; line-height: 1.35; display:none; margin-bottom: 12px; }
    .alert.show{display:block} .alert b{color: #fff}
    .form{ display:grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
    @media (max-width: 520px){ .form{grid-template-columns: repeat(2, 1fr);} }
    .group{display:flex; flex-direction:column; gap: 7px;}
    label{ font-size: 12px; color: var(--muted); font-weight: 900; letter-spacing: .2px; position: relative; display: inline-flex; align-items: center; gap: 6px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; min-height: 16px; }
    .tooltip{ position: relative; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; width: 16px; height: 16px; border-radius: 50%; background: rgba(139,92,246,.2); color: var(--accent); font-size: 10px; font-weight: 900; flex-shrink: 0; transition: box-shadow .15s ease, transform .15s ease; }
    .tooltip:focus-visible{ outline: none; box-shadow: 0 0 0 3px rgba(139,92,246,.25); transform: translateY(-1px); }
    #globalTooltip{ position: fixed; display: none; padding: 8px 12px; background: rgba(5,8,16,.95); color: #fff; border-radius: 8px; font-size: 11px; font-weight: 600; white-space: nowrap; box-shadow: 0 8px 24px rgba(0,0,0,.4); z-index: 9999; border: 1px solid rgba(139,92,246,.4); pointer-events: none; }
    .input{ width:100%; padding: 14px 12px; border-radius: 12px; border: 1px solid var(--border); background: rgba(0,0,0,.22); color: var(--text); outline:none; font-weight: 900; font-size: 15px; transition: box-shadow .15s ease, border-color .15s ease, transform .15s ease, background .15s ease; min-height: 44px; position: relative; }
    .input:focus{ border-color: var(--accent); background: rgba(139, 92, 246, 0.1); box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.15), 0 0 15px rgba(139, 92, 246, 0.3); transform: translateY(-2px); }
    .input:valid:not(:placeholder-shown){ border-color: rgba(34,197,94,.4); box-shadow: 0 0 0 2px rgba(34,197,94,.08); }
    .group .input[type="number"]:not(:placeholder-shown){ border-color: rgba(34,197,94,.4); box-shadow: 0 0 0 2px rgba(34,197,94,.08); }
    .group .input[type="text"]:not(:placeholder-shown){ border-color: rgba(34,197,94,.4); box-shadow: 0 0 0 2px rgba(34,197,94,.08); }
    .input.error{ border-color: rgba(239,68,68,.7); box-shadow: 0 0 0 4px rgba(239,68,68,.12); background: rgba(239,68,68,.08); }
    .help{ margin-top: 12px; padding: 12px 12px; border-radius: 14px; border: 1px solid rgba(139,92,246,.25); background: rgba(139,92,246,.10); color: var(--muted); font-size: 12px; line-height: 1.35; }
    .row{ display:flex; gap: 12px; align-items:center; justify-content: space-between; flex-wrap: wrap; margin-top: 12px; }
    .kwhPill{ display:flex; align-items:baseline; flex-wrap:wrap; gap: 10px; padding: 10px 12px; border-radius: 14px; border: 1px solid var(--border); background: rgba(0,0,0,.18); min-height: 44px; }
    .kwhLabel{ color: var(--muted2); font-weight: 900; letter-spacing: .3px; text-transform: uppercase; font-size: 11px; }
    .kwhValue{ font-family: var(--mono); font-size: 17px; font-weight: 1000; letter-spacing: -.2px; color: rgba(255,255,255,.94); }
    @media (max-width: 520px){ .kwhValue{font-size: 16px;} .row{gap: 10px;} }
    .heroKpis{ display:grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 18px; }
    @media (max-width: 760px){ .heroKpis{grid-template-columns: 1fr;} }
    .heroCard{ padding: 18px 16px; border-radius: 18px; border: 1px solid var(--border); background: linear-gradient(135deg, rgba(139,92,246,.14), rgba(34,197,94,.06)); position:relative; overflow:hidden; min-height: 120px; display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center; gap: 10px; animation: fadeInUp 0.6s ease-out; animation-delay: 0.1s; animation-fill-mode: both; }
    .heroCard.best{ border: 2px solid rgba(251, 191, 36, .6); background: linear-gradient(135deg, rgba(251, 191, 36, .15), rgba(139,92,246,.10)); animation: fadeInUp 0.6s ease-out, goldenPulse 2s ease-in-out infinite; animation-delay: 0.1s, 0.8s; animation-fill-mode: both, forwards; position: relative; }
    .heroCard.best::before{ content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,.1), transparent); animation: shine 3s infinite; }
    @keyframes shine { 0% { left: -100%; } 50%, 100% { left: 200%; } }
    .heroCard .k{ font-size: 11px; letter-spacing: 1.2px; text-transform: uppercase; color: var(--muted2); font-weight: 1000; display:flex; align-items:center; gap: 6px; }
    .heroCard.best .k::before{ content: "üèÜ"; font-size: 14px; }
    .heroCard .v{ font-size: clamp(28px, 2.6vw, 44px); font-weight: 1100; letter-spacing: -0.6px; line-height: 1.0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .heroCard .s{ color: var(--muted); font-size: 12px; line-height: 1.25; }
    .statsbar{ display:grid; grid-template-columns: repeat(3, 1fr); gap: 14px; margin-bottom: 18px; opacity: .92; }
    @media (max-width: 760px){ .statsbar{grid-template-columns: 1fr;} }
    .statCard{ border: 1px solid var(--border); background: rgba(0,0,0,.14); border-radius: 16px; padding: 12px 12px; display:flex; flex-direction:column; gap: 6px; animation: fadeInUp 0.5s ease-out; animation-fill-mode: both; align-items: center; text-align: center; }
    .statCard:nth-child(1) { animation-delay: 0.2s; } .statCard:nth-child(2) { animation-delay: 0.3s; } .statCard:nth-child(3) { animation-delay: 0.4s; }
    .statLabel{ color: var(--muted2); letter-spacing: 1px; text-transform: uppercase; font-size: 10px; font-weight: 1000; }
    .statValue{ font-size: clamp(18px, 1.5vw, 24px); font-weight: 1100; letter-spacing: -0.4px; white-space: nowrap; }
    .badge{ display:inline-flex; align-items:center; justify-content:center; padding: 6px 10px; border-radius: 10px; border: 1px solid var(--border); background: rgba(255,255,255,.06); font-weight: 1000; font-size: 11px; letter-spacing: .3px; transition: transform .15s ease, box-shadow .15s ease; }
    .badge.b1{ border: none; background: linear-gradient(135deg, rgba(59,130,246,.9), rgba(96,165,250,.8)); color: #fff; box-shadow: 0 4px 12px rgba(59,130,246,.3); }
    .badge.b1:hover{ transform: scale(1.05); box-shadow: 0 6px 16px rgba(59,130,246,.4); }
    .badge.b3{ border: none; background: linear-gradient(135deg, rgba(245,158,11,.9), rgba(251,191,36,.8)); color: #fff; box-shadow: 0 4px 12px rgba(245,158,11,.3); }
    .badge.b3:hover{ transform: scale(1.05); box-shadow: 0 6px 16px rgba(245,158,11,.4); }
    .toolbar{ display:flex; align-items:center; justify-content:flex-end; gap: 12px; margin: 10px 0 12px; flex-wrap: wrap; }
    .filters{display:flex; gap: 10px; flex-wrap: wrap;}
    .fbtn{ padding: 10px 12px; border-radius: 12px; border: 1px solid var(--border); background: rgba(255,255,255,.06); color: var(--muted); cursor:pointer; font-weight: 1000; font-size: 12px; transition: transform .15s ease, border-color .15s ease, background .15s ease; user-select:none; min-height: 44px; display:flex; align-items:center; }
    .fbtn:hover{transform: translateY(-1px); border-color: var(--border2); background: rgba(255,255,255,.09);}
    .fbtn.active{ background: rgba(139,92,246,.18); border-color: rgba(139,92,246,.55); color: var(--text); }
    .tableWrap{ background: transparent !important; border: none !important; overflow: visible !important; }
    table{ width: 100%; border-collapse: separate !important; border-spacing: 0 8px; table-layout: fixed; }
    thead th:nth-child(1), tbody td:nth-child(1) { width: 4%; }
    thead th:nth-child(2), tbody td:nth-child(2) { width: 23%; }
    thead th:nth-child(3), tbody td:nth-child(3) { width: 10%; }
    thead th:nth-child(4), tbody td:nth-child(4) { width: 10%; }
    thead th:nth-child(5), tbody td:nth-child(5) { width: 11%; }
    thead th:nth-child(6), tbody td:nth-child(6) { width: 10%; }
    thead th:nth-child(7), tbody td:nth-child(7) { width: 12%; }
    thead th:nth-child(8), tbody td:nth-child(8) { width: 8%; }
    thead th:nth-child(9), tbody td:nth-child(9) { width: 8%; }
    thead th{ position: sticky; top: 0; z-index: 5; text-align:right; padding: 14px 12px; font-size: 11px !important; letter-spacing: 1.5px; text-transform: uppercase; color: var(--muted) !important; background: transparent !important; border-bottom: none !important; user-select:none; white-space: nowrap; padding-bottom: 15px; }
    thead th:first-child, tbody td:first-child{text-align:center}
    thead th:nth-child(2), tbody td:nth-child(2){text-align:left; white-space: nowrap;}
    thead th.sort{cursor:pointer}
    thead th.sort:hover{background: rgba(139,92,246,.12)}
    .sortIcon{opacity:.8; font-size: 12px; margin-left: 6px;}
    tbody tr { background: rgba(255, 255, 255, 0.03); transition: all 0.2s ease; backdrop-filter: blur(10px); }
    tbody td{ padding: 14px 12px; border-bottom: none !important; text-align:right; font-size: 15px; color: rgba(255,255,255,.88); vertical-align: middle; white-space: nowrap; }
    tbody tr td:first-child { border-radius: 12px 0 0 12px; }
    tbody tr td:last-child  { border-radius: 0 12px 12px 0; }
    tbody td:nth-child(2){ font-weight: 1100; color: #fff; font-size: 14px; }
    tbody tr:hover{ transform: scale(1.01) translateY(-2px) translateZ(0); background: rgba(255, 255, 255, 0.07); box-shadow: 0 10px 20px rgba(0,0,0,0.2); z-index: 10; position: relative; }
    tbody tr.best{ background: linear-gradient(90deg, rgba(34,197,94,0.15), rgba(139,92,246,0.1)) !important; border: 1px solid rgba(34,197,94,0.3); box-shadow: 0 0 20px rgba(34,197,94,0.1); }
    tbody tr.best td:nth-child(2)::before{ content: "üèÜ "; font-size: 14px; margin-right: 4px; }
    tbody tr:nth-child(1) td:first-child { color: #FFD700; font-weight: 1000; font-size: 1.3em; text-shadow: 0 0 15px rgba(255, 215, 0, 0.4); }
    tbody tr:nth-child(2) td:first-child { color: #C0C0C0; font-weight: 1000; font-size: 1.2em; text-shadow: 0 0 10px rgba(192, 192, 192, 0.3); }
    tbody tr:nth-child(3) td:first-child { color: #CD7F32; font-weight: 1000; font-size: 1.2em; text-shadow: 0 0 10px rgba(205, 127, 50, 0.3); }
    td.vs{white-space: nowrap; position:relative;}
    .vs-text{ font-weight: 1100; min-width: 65px; text-align: right; }
    .vs-text.pos{color: rgba(239,68,68,.95);}
    .vs-text.neg{color: rgba(34,197,94,.95);}
    .vs-text.zero{color: var(--muted2);}
    .web{ display:inline-flex; width: 38px; height:38px; border-radius: 12px; border: 1px solid var(--border); background: linear-gradient(135deg, rgba(139,92,246,.18), rgba(34,197,94,.10)); align-items:center; justify-content:center; text-decoration:none; transition: transform .15s ease, border-color .15s ease, background .15s ease; }
    .web:hover{transform: translateY(-1px) scale(1.04); border-color: var(--border2); background: linear-gradient(135deg, rgba(139,92,246,.30), rgba(34,197,94,.16));}
    .web:active{transform: translateY(0px) scale(.98)}
    .empty{ padding: 14px; color: var(--muted); font-size: 13px; }
    .menu{position:relative;}
    .menuPanel{ position:absolute; right:0; top: calc(100% + 10px); min-width: 260px; background: rgba(5,8,16,.92); border: 1px solid var(--border); border-radius: 16px; box-shadow: var(--shadow2); backdrop-filter: blur(14px); padding: 8px; display:none; z-index: 50; }
    .menuPanel.show{display:block; animation: popMenu .16s ease;}
    @keyframes popMenu{ from{opacity:0; transform: translateY(6px);} to{opacity:1; transform: translateY(0px);} }
    .menuItem{ width: 100%; text-align:left; padding: 10px 10px; border-radius: 12px; border: 1px solid transparent; background: transparent; color: rgba(255,255,255,.92); cursor:pointer; font-weight: 1000; font-size: 13px; display:flex; align-items:center; justify-content:space-between; gap: 10px; white-space: nowrap; min-height: 44px; }
    .menuItem:hover{ background: rgba(255,255,255,.06); border-color: rgba(255,255,255,.08); }
    .mi-left{ white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .mi-right{ opacity: .6; white-space: nowrap; flex: 0 0 auto; }
    .menuDivider{ height:1px; background: rgba(255,255,255,.08); margin: 6px 6px; }
    .menuHint{ padding: 8px 10px 6px 10px; color: var(--muted2); font-size: 11px; font-weight: 900; letter-spacing: .2px; }
    .toast{ position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: rgba(5,8,16,.92); border: 1px solid var(--border); color: var(--text); border-radius: 16px; box-shadow: var(--shadow2); padding: 12px 14px; display:none; gap: 10px; align-items:center; max-width: min(760px, calc(100vw - 24px)); backdrop-filter: blur(14px); z-index: 9999; font-size: 13px; }
    .toast.show{display:flex; animation: pop .22s ease;}
    @keyframes pop { from{opacity:0; transform: translateX(-50%) translateY(8px);} to{opacity:1; transform: translateX(-50%) translateY(0px);} }
    .dot{width:10px; height:10px; border-radius:999px; background: var(--accent);}
    .dot.ok{background: var(--accent2)}
    .dot.err{background: var(--danger)}
    .scroll-btn{ position: fixed; bottom: 90px; right: 30px; padding: 14px 20px; background: linear-gradient(135deg, var(--accent), var(--accent2)); color: #fff; border: none; border-radius: 999px; font-weight: 900; font-size: 13px; cursor: pointer; box-shadow: 0 8px 24px rgba(139,92,246,.4); z-index: 9998; animation: bounce 2s ease-in-out infinite; transition: transform .2s ease, box-shadow .2s ease; }
    .scroll-btn:hover{ transform: translateY(-2px) scale(1.05); box-shadow: 0 12px 32px rgba(139,92,246,.6); }
    @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
    @media (max-width: 768px) {
      thead { display: none; }
      tbody tr { display: block; margin-bottom: 20px; border: 1px solid var(--border); border-radius: 16px; padding: 15px; background: var(--card); box-shadow: var(--shadow2); }
      tbody td { display: flex; justify-content: space-between; align-items: center; text-align: right; padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.05); width: 100% !important; box-sizing: border-box; font-size: 14px; }
      tbody td:last-child { border-bottom: none; }
      tbody td:nth-of-type(1)::before { content: "Ranking"; font-weight:900; color:var(--muted); }
      tbody td:nth-of-type(2)::before { content: "Compa√±√≠a"; display:none; }
      tbody td:nth-of-type(3)::before { content: "Potencia"; font-weight:900; color:var(--muted); }
      tbody td:nth-of-type(4)::before { content: "Consumo"; font-weight:900; color:var(--muted); }
      tbody td:nth-of-type(5)::before { content: "Impuestos"; font-weight:900; color:var(--muted); }
      tbody td:nth-of-type(6)::before { content: "TOTAL"; font-weight:900; color:var(--accent); font-size:1.2em; }
      tbody td:nth-of-type(7)::before { content: "Diferencia"; font-weight:900; color:var(--muted); }
      tbody td:nth-of-type(8)::before { content: "Tipo"; font-weight:900; color:var(--muted); }
      tbody td:nth-of-type(9)::before { content: "Contratar"; font-weight:900; color:var(--muted); }
      tbody td:nth-of-type(2) { display:block; text-align:center; font-size: 18px !important; margin-bottom: 10px; padding-bottom:10px; border-bottom: 2px solid var(--border); color: #fff; }
      .scroll-btn{ bottom: 80px; right: 20px; font-size: 12px; padding: 12px 16px; }
    }
    @media (min-width: 1400px){ thead th:nth-child(2), tbody td:nth-child(2) { width: 28%; } tbody td:nth-child(2) { font-size: 15px; } }
    .container { min-height: 100vh; }
    #heroKpis { min-height: 260px; }
    #statsBar { min-height: 80px; }
    #table { min-height: 300px; }

    .btn:hover,
    .fbtn:hover,
    .web:hover {
      will-change: transform;
    }

    .fade-container {
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.3s ease;
    }

    .fade-container.show {
      opacity: 1;
      visibility: visible;
    }

    /* === GR√ÅFICO TOP 5 TARIFAS === */
    .chartTop {
      margin-bottom: 16px;
      border-radius: 16px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,.18);
      padding: 14px 14px 10px 14px;
    }

    .chartTop-header {
      margin-bottom: 10px;
    }

    .chartTop-body {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .chartTop-row {
      display: grid;
      grid-template-columns: minmax(0, 1.6fr) minmax(0, 3fr) auto;
      align-items: center;
      gap: 10px;
      font-size: 13px;
    }

    .chartTop-name {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: var(--muted);
      font-weight: 900;
    }

    .chartTop-barTrack {
      position: relative;
      height: 18px;
      border-radius: 999px;
      background: rgba(255,255,255,.05);
      overflow: hidden;
    }

    .chartTop-barFill {
      height: 100%;
      border-radius: inherit;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      width: 0%;
      transition: width 0.6s ease;
    }

    .chartTop-value {
      font-family: var(--mono);
      font-weight: 900;
      font-size: 13px;
      white-space: nowrap;
      color: var(--text);
    }

    .chartTop-row.best .chartTop-barTrack {
      box-shadow: 0 0 14px rgba(34,197,94,.45);
    }

    .chartTop-row.best .chartTop-name {
      color: var(--text);
    }

    .chartTop-row.best .chartTop-name::before {
      content: "üèÜ ";
    }

    @media (max-width: 768px) {
      .chartTop-row {
        grid-template-columns: minmax(0, 1fr) minmax(0, 2fr) auto;
        font-size: 12px;
      }
      
      .chartTop-value {
        font-size: 12px;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="topbar">
      <div class="brand">
        <span class="particle"></span><span class="particle"></span><span class="particle"></span><span class="particle"></span><span class="particle"></span><span class="particle"></span>
        <div class="logo" aria-hidden="true">
          <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" style="width:100%;height:100%;">
            <defs>
              <linearGradient id="logoGrad1" x1="0%" y1="0%" x2="100%" y2="100%">
                <stop offset="0%" style="stop-color:#fbbf24;stop-opacity:1"><animate attributeName="stop-color" values="#fbbf24;#f59e0b;#fbbf24" dur="2s" repeatCount="indefinite"/></stop>
                <stop offset="50%" style="stop-color:#f59e0b;stop-opacity:1"/>
                <stop offset="100%" style="stop-color:#fbbf24;stop-opacity:1"><animate attributeName="stop-color" values="#fbbf24;#f59e0b;#fbbf24" dur="2s" repeatCount="indefinite"/></stop>
              </linearGradient>
              <linearGradient id="logoGrad2" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:#8b5cf6;stop-opacity:1"/><stop offset="100%" style="stop-color:#6366f1;stop-opacity:1"/></linearGradient>
              <filter id="glow"><feGaussianBlur stdDeviation="2" result="coloredBlur"/><feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
            </defs>
            <circle cx="50" cy="50" r="35" fill="url(#logoGrad2)" opacity="0.2"><animate attributeName="r" values="35;38;35" dur="2s" repeatCount="indefinite"/><animate attributeName="opacity" values="0.2;0.4;0.2" dur="2s" repeatCount="indefinite"/></circle>
            <path d="M 55 15 L 35 48 L 48 48 L 45 85 L 70 45 L 57 45 Z" fill="url(#logoGrad1)" filter="url(#glow)" stroke="#fff" stroke-width="1.5" stroke-linejoin="round"><animateTransform attributeName="transform" attributeType="XML" type="scale" values="1;1.08;1" dur="1.5s" repeatCount="indefinite" additive="sum"/></path>
            <circle cx="30" cy="30" r="2" fill="#fbbf24" opacity="0"><animate attributeName="opacity" values="0;1;0" dur="1.5s" repeatCount="indefinite"/><animate attributeName="r" values="2;3;2" dur="1.5s" repeatCount="indefinite"/></circle>
            <circle cx="70" cy="35" r="2" fill="#fbbf24" opacity="0"><animate attributeName="opacity" values="0;1;0" dur="1.5s" begin="0.5s" repeatCount="indefinite"/><animate attributeName="r" values="2;3;2" dur="1.5s" begin="0.5s" repeatCount="indefinite"/></circle>
            <circle cx="65" cy="70" r="2" fill="#fbbf24" opacity="0"><animate attributeName="opacity" values="0;1;0" dur="1.5s" begin="1s" repeatCount="indefinite"/><animate attributeName="r" values="2;3;2" dur="1.5s" begin="1s" repeatCount="indefinite"/></circle>
          </svg>
        </div>
        <div><h1>Comparador de Tarifas</h1><p>Encuentra la tarifa m√°s barata en segundos</p></div>
      </div>

      <div class="actions">
        <div class="pill" id="statusPill" role="status" aria-live="polite"><span id="statusText">Listo para calcular</span></div>
        <div class="menu" id="menuRoot">
          <button class="btn" id="btnMenu" type="button" aria-haspopup="true" aria-expanded="false" title="Opciones">‚öôÔ∏è</button>
          <div class="menuPanel" id="menuPanel" role="menu" aria-label="Opciones">
            <div class="menuHint">Opciones</div>
            <button class="menuItem" id="btnExport" type="button" role="menuitem">
              <span class="mi-left">‚¨áÔ∏è Descargar CSV</span>
              <span class="mi-right">ranking</span>
            </button>
            <button class="menuItem" id="btnShare" type="button" role="menuitem">
              <span class="mi-left">üîó Compartir configuraci√≥n</span>
              <span class="mi-right">URL</span>
            </button>
            <div class="menuDivider"></div>
            <button class="menuItem" id="btnReset" type="button" role="menuitem">
              <span class="mi-left">‚Ü∫ Restablecer</span>
              <span class="mi-right">valores</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <div class="grid">
      <section class="card">
        <div class="head"><div class="kicker">Tus datos</div><div class="title">Potencia y consumos (kWh)</div></div>
        <div class="body">
          <div class="alert" id="errorBox"><b>Error:</b> <span id="errorText"></span></div>
          <div class="form">
            <div class="group"><label for="p1">Potencia P1 (kW)</label><input id="p1" class="input" type="text" inputmode="decimal" pattern="[0-9]*" autocomplete="off" placeholder="Ej: 3,45" /></div>
            <div class="group"><label for="p2">Potencia P2 (kW)</label><input id="p2" class="input" type="text" inputmode="decimal" pattern="[0-9]*" autocomplete="off" placeholder="Ej: 3,45" /></div>
            <div class="group"><label for="dias">D√≠as factura</label><input id="dias" class="input" type="text" inputmode="numeric" pattern="[0-9]*" autocomplete="off" placeholder="1 a 365" /></div>
          </div>
          <div style="height:12px"></div>
            <div class="form">
            <div class="group"><label for="cPunta">Consumo PUNTA <span class="tooltip" data-tip="10h-14h y 18h-22h" role="button" tabindex="0" aria-label="Horario de consumo punta">i</span></label><input id="cPunta" class="input" type="text" inputmode="decimal" pattern="[0-9]*" autocomplete="off" placeholder="Ej: 120" /></div>
            <div class="group"><label for="cLlano">Consumo LLANO <span class="tooltip" data-tip="8h-10h, 14h-18h y 22h-24h" role="button" tabindex="0" aria-label="Horario de consumo llano">i</span></label><input id="cLlano" class="input" type="text" inputmode="decimal" pattern="[0-9]*" autocomplete="off" placeholder="Ej: 80" /></div>
            <div class="group"><label for="cValle">Consumo VALLE <span class="tooltip" data-tip="0h-8h (madrugada)" role="button" tabindex="0" aria-label="Horario de consumo valle">i</span></label><input id="cValle" class="input" type="text" inputmode="decimal" pattern="[0-9]*" autocomplete="off" placeholder="Ej: 150" /></div>
          </div>
          <div class="row" style="margin-top:14px">
            <div class="kwhPill" aria-live="polite"><div class="kwhLabel">Total kWh</div><div class="kwhValue" id="kwhHint">‚Äî</div></div>
            <button class="btn primary" id="btnCalc" type="button" title="Calcular ahora"><span id="btnText">‚ö° Calcular</span><span id="btnSpinner" style="display:none;"><span class="spinner"></span></span></button>
          </div>
          <div class="help">Los datos iniciales ya est√°n calculados. Modifica cualquier valor para actualizar el ranking al momento.</div>
        </div>
      </section>

      <section class="card">
        <div class="head"><div class="kicker">Resultados</div><div class="title">Tarifa √≥ptima + ranking</div></div>
        <div class="body">
          <div class="heroKpis fade-container" id="heroKpis">
            <div class="heroCard best"><div class="k">Tarifa m√°s barata</div><div class="v" id="kpiBest">‚Äî</div><div class="s">Mejor opci√≥n</div></div>
            <div class="heroCard"><div class="k">Factura m√≠nima</div><div class="v" id="kpiPrice">‚Äî</div><div class="s">Seg√∫n tus datos</div></div>
          </div>

          <div class="statsbar fade-container" id="statsBar">
            <div class="statCard"><div class="statLabel">Precio m√≠nimo</div><div class="statValue" id="statMin">‚Äî</div></div>
            <div class="statCard"><div class="statLabel">Precio medio</div><div class="statValue" id="statAvg">‚Äî</div></div>
            <div class="statCard"><div class="statLabel">Precio m√°ximo</div><div class="statValue" id="statMax">‚Äî</div></div>
          </div>

          <div class="chartTop fade-container" id="chartTop">
            <div class="chartTop-header">
              <div class="kicker">Comparaci√≥n visual</div>
              <div class="title">Top 5 tarifas (total factura)</div>
            </div>
            <div class="chartTop-body" id="chartTopBody"></div>
          </div>

          <div class="toolbar fade-container" id="toolbar">
            <div class="filters">
              <button class="fbtn active" data-filter="all" type="button">Todas</button>
              <button class="fbtn" data-filter="1P" type="button"><span class="badge b1">1P</span></button>
              <button class="fbtn" data-filter="3P" type="button"><span class="badge b3">3P</span></button>
            </div>
          </div>

          <div class="tableWrap">
            <table id="table" class="fade-container">
              <thead>
                <tr>
                  <th>#</th>
                  <th class="sort" data-sort="nombre">Tarifa <span class="sortIcon" id="si_nombre"></span></th>
                  <th class="sort" data-sort="potenciaNum">Potencia <span class="sortIcon" id="si_potenciaNum"></span></th>
                  <th class="sort" data-sort="consumoNum">Consumo <span class="sortIcon" id="si_consumoNum"></span></th>
                  <th class="sort" data-sort="impuestosNum">Impuestos <span class="sortIcon" id="si_impuestosNum"></span></th>
                  <th class="sort" data-sort="totalNum">Total <span class="sortIcon" id="si_totalNum"></span></th>
                  <th class="sort" data-sort="vsMejorNum">Vs mejor <span class="sortIcon" id="si_vsMejorNum"></span></th>
                  <th>Tipo</th><th>Web</th>
                </tr>
              </thead>
              <tbody id="tbody"></tbody>
            </table>
            <div class="empty fade-container" id="emptyBox">A√∫n no hay resultados. Calcula para mostrar ranking.</div>
          </div>

        </div>
      </section>
    </div>

    <footer style="text-align:center; padding:40px 20px 30px; margin-top:40px; opacity:0.6; font-size:13px; color: var(--muted2);">
      <p style="margin:0;">‚ö° Comparador de tarifas el√©ctricas</p>
      <p style="margin:8px 0 0; font-weight:600;">Creado por <strong style="color: var(--accent);">aLMaX</strong></p>
      <p style="margin:8px 0 0; font-size:11px;">Proyecto gratuito y sin publicidad</p>
    </footer>
  </div>

  <div class="toast" id="toast"><span class="dot" id="toastDot"></span><span id="toastText"></span></div>
  <button id="scrollToResults" class="scroll-btn" style="display:none;" title="Ver resultados">‚Üì Ver resultados</button>
  <div id="globalTooltip" role="tooltip" aria-hidden="true"></div>

  <script>
    const $ = id => document.getElementById(id);
    
    // URL DEL JSON EST√ÅTICO DE TARIFAS EN EL MISMO HOST
    const JSON_URL = 'tarifas.json';

    const LS_KEY = 'almax_comparador_v6_inputs';

    // VALORES POR DEFECTO PARA PRIMERA VISITA
    const DEFAULTS = { p1:'3,45', p2:'3,45', dias:'30', cPunta:'100', cLlano:'100', cValle:'100' };
    
    // RECOGIDA DE PAR√ÅMETROS URL (para enlaces compartidos)
    const params = new URLSearchParams(window.location.search);
    const SERVER_PARAMS = {};
    for (const [key, value] of params.entries()) { SERVER_PARAMS[key] = value; }

    const el = {
      inputs: { p1:$('p1'), p2:$('p2'), dias:$('dias'), cPunta:$('cPunta'), cLlano:$('cLlano'), cValle:$('cValle') },
      btnCalc: $('btnCalc'), btnText: $('btnText'), btnSpinner: $('btnSpinner'),
      statusPill: $('statusPill'), statusText: $('statusText'), errorBox: $('errorBox'), errorText: $('errorText'),
      kwhHint: $('kwhHint'), heroKpis: $('heroKpis'), kpiBest: $('kpiBest'), kpiPrice: $('kpiPrice'),
      statsBar: $('statsBar'), statMin: $('statMin'), statAvg: $('statAvg'), statMax: $('statMax'),
      toolbar: $('toolbar'), table: $('table'), tbody: $('tbody'), emptyBox: $('emptyBox'),
      toast: $('toast'), toastText: $('toastText'), toastDot: $('toastDot'),
      menuRoot: $('menuRoot'), btnMenu: $('btnMenu'), menuPanel: $('menuPanel'),
      btnExport: $('btnExport'), btnReset: $('btnReset'), btnShare: $('btnShare'),
      globalTooltip: $('globalTooltip')
    };

    const state = { filter: 'all', sort: { key: 'totalNum', dir: 'asc' }, rows: [], lastSignature: null };
    let cachedTarifas = [];

    let activeTooltip = null;
    let tooltipPinned = false;

    function positionTooltip(target){
      if(!target)return;
      const tip = target.getAttribute('data-tip') || '';
      el.globalTooltip.textContent = tip;
      el.globalTooltip.style.display = 'block';
      el.globalTooltip.style.visibility = 'hidden';
      el.globalTooltip.style.opacity = '0';
      el.globalTooltip.setAttribute('aria-hidden', tip ? 'false' : 'true');
      const rect = target.getBoundingClientRect();
      const ttRect = el.globalTooltip.getBoundingClientRect();
      let top = rect.top - ttRect.height - 10;
      if(top < 8) top = rect.bottom + 10;
      let left = rect.left + rect.width / 2 - ttRect.width / 2;
      const maxLeft = window.innerWidth - ttRect.width - 8;
      left = Math.max(8, Math.min(maxLeft, left));
      el.globalTooltip.style.top = `${top}px`;
      el.globalTooltip.style.left = `${left}px`;
      el.globalTooltip.style.visibility = 'visible';
      el.globalTooltip.style.opacity = '1';
    }

    function hideTooltip(force=false){
      if(!force && tooltipPinned)return;
      el.globalTooltip.style.display = 'none';
      el.globalTooltip.setAttribute('aria-hidden','true');
      activeTooltip = null;
      tooltipPinned = false;
    }

    function openTooltip(target){
      activeTooltip = target;
      positionTooltip(target);
    }

    function initTooltips(){
      const tooltips = Array.from(document.querySelectorAll('.tooltip'));
      tooltips.forEach(t => {
        t.addEventListener('mouseenter', () => { tooltipPinned = false; openTooltip(t); });
        t.addEventListener('mouseleave', () => { if(tooltipPinned && activeTooltip===t)return; hideTooltip(); });
        t.addEventListener('focus', () => { tooltipPinned = false; openTooltip(t); });
        t.addEventListener('blur', () => hideTooltip(true));
        t.addEventListener('click', (evt) => {
          evt.preventDefault();
          if(activeTooltip===t && tooltipPinned){ hideTooltip(true); return; }
          tooltipPinned = true;
          openTooltip(t);
        });
        t.addEventListener('keydown', (evt) => {
          if(evt.key==='Enter' || evt.key===' '){ evt.preventDefault(); t.click(); }
        });
      });

      document.addEventListener('click', (evt) => {
        if(!tooltipPinned)return;
        if(!evt.target.closest('.tooltip')) hideTooltip(true);
      });

      window.addEventListener('scroll', () => { if(activeTooltip) positionTooltip(activeTooltip); }, {capture:true, passive:true});
      window.addEventListener('resize', () => { if(activeTooltip) positionTooltip(activeTooltip); });
      document.addEventListener('keydown', (evt) => { if(evt.key==='Escape') hideTooltip(true); });
    }

    function parseNum(str){ 
      if(str===null||str===undefined)return 0;
      if(typeof str==='number')return Number.isFinite(str)?str:0; 
      let s=String(str).trim().replace(/\s/g,''); 
      if(!s)return 0; 
      if(s.includes(',')&&s.includes('.')){const lc=s.lastIndexOf(',');const ld=s.lastIndexOf('.');if(lc>ld)s=s.replace(/\./g,'').replace(',','.');else s=s.replace(/,/g,'');}else if(s.includes(',')){s=s.replace(',','.');} 
      s=s.replace(/[^\d.-]/g,''); const n=Number(s); return Number.isFinite(n)?n:0;
    }

    function escapeHtml(v){ return String(v??'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;'); }

    function setStatus(text, mode='idle'){ 
      el.statusText.textContent=text; 
      el.statusPill.classList.remove('loading','ok','err'); 
      if(mode==='loading')el.statusPill.classList.add('loading'); 
      if(mode==='ok')el.statusPill.classList.add('ok'); 
      if(mode==='err')el.statusPill.classList.add('err'); 
      const l=mode==='loading'; 
      el.btnCalc.disabled=l; 
      el.btnText.style.display=l?'none':'flex'; 
      el.btnSpinner.style.display=l?'flex':'none'; 
      if(l)el.btnCalc.classList.add('calculating'); else el.btnCalc.classList.remove('calculating'); 
    }

    function toast(msg, mode='ok'){ 
      el.toastText.textContent=msg; 
      el.toastDot.classList.remove('ok','err'); 
      el.toastDot.classList.add(mode==='err'?'err':'ok'); 
      el.toast.classList.add('show'); 
      clearTimeout(el.toast._t); 
      el.toast._t=setTimeout(()=>el.toast.classList.remove('show'),2800); 
    }

    async function copyText(text) {
      if (navigator.clipboard && navigator.clipboard.writeText) {
        try {
          await navigator.clipboard.writeText(text);
          return true;
        } catch (e) {}
      }
      const ta = document.createElement('textarea');
      ta.value = text;
      ta.style.position = 'fixed';
      ta.style.opacity = '0';
      document.body.appendChild(ta);
      ta.focus();
      ta.select();
      try { document.execCommand('copy'); } catch (e) {}
      document.body.removeChild(ta);
      return true;
    }
    
    // ‚ö° LEER TARIFAS DESDE tarifas.json EN EL MISMO HOST
    async function fetchTarifas(forceRefresh = false) {
        if (!forceRefresh && cachedTarifas.length > 0) return true;
        setStatus('Cargando tarifas...', 'loading');
        try {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 15000);

            const response = await fetch(JSON_URL, { signal: controller.signal, cache: forceRefresh ? 'no-cache' : 'default' });
            clearTimeout(timeoutId);

            if (!response.ok) {
                throw new Error('HTTP ' + response.status);
            }
            
            const data = await response.json();
            const tarifas = Array.isArray(data.tarifas) ? data.tarifas : null;

            if (tarifas && tarifas.length) {
                cachedTarifas = tarifas;
                setStatus('Datos actualizados', 'ok');
                setTimeout(() => setStatus('Listo para calcular', 'idle'), 1500);
                return true;
            } else {
                throw new Error('JSON sin tarifas v√°lidas');
            }
        } catch (e) {
            console.error('Error cargando tarifas JSON:', e);
            setStatus('Error conexi√≥n', 'err');
            toast('Error cargando tarifas desde el servidor.', 'err');
            return false;
        }
    }

    function formatMoney(n) { return n.toFixed(2).replace('.', ',') + ' ‚Ç¨'; }

    function getInputValues() {
        return {
            p1: parseNum(el.inputs.p1.value),
            p2: parseNum(el.inputs.p2.value),
            dias: Math.trunc(parseNum(el.inputs.dias.value)) || 30,
            cPunta: parseNum(el.inputs.cPunta.value),
            cLlano: parseNum(el.inputs.cLlano.value),
            cValle: parseNum(el.inputs.cValle.value)
        };
    }

    function signatureFromValues(v) {
        return [v.p1, v.p2, v.dias, v.cPunta, v.cLlano, v.cValle].join('|');
    }

    function calculateLocal(values) {
        const { p1, p2, dias, cPunta, cLlano, cValle } = values || getInputValues();

        if(!cachedTarifas.length) return;

        const resultados = cachedTarifas.map((t, index) => {
            const pot = (p1 * dias * t.p1) + (p2 * dias * t.p2);
            const cons = (cPunta * t.cPunta) + (cLlano * t.cLlano) + (cValle * t.cValle);
            const tarifaAcceso = (4.650987 / 365 * dias);
            const sumaBase = pot + cons + tarifaAcceso;
            const impuestoElec = Math.max((5.11269632 / 100) * sumaBase, (cPunta + cLlano + cValle) * 0.001);
            const margen = dias * 0.026667;
            const subtotal = sumaBase + impuestoElec + margen;
            const iva = subtotal * 0.21; 
            const total = subtotal + iva;
            
            return {
                ...t,
                posicion: index + 1,
                potenciaNum: pot, potencia: formatMoney(pot),
                consumoNum: cons, consumo: formatMoney(cons),
                impuestosNum: impuestoElec + margen + iva,
                impuestos: formatMoney(impuestoElec + margen + iva),
                totalNum: total, total: formatMoney(total),
                webUrl: t.web
            };
        });

        resultados.sort((a, b) => a.totalNum - b.totalNum);
        
        const bestPrice = resultados[0].totalNum;
        const processed = resultados.map((r, i) => {
            const diff = r.totalNum - bestPrice;
            return {
                ...r, posicion: i + 1, esMejor: i === 0,
                vsMejorNum: diff, vsMejor: i === 0 ? '‚Äî' : '+' + formatMoney(diff)
            };
        });

        const prices = processed.map(r => r.totalNum);
        const min = Math.min(...prices); 
        const max = Math.max(...prices);
        const avg = prices.reduce((a,b)=>a+b,0) / prices.length;

        renderAll({
            success: true,
            resumen: { mejor: processed[0].nombre, precio: formatMoney(processed[0].totalNum) },
            stats: { precioMin: formatMoney(min), precioMax: formatMoney(max), precioMedio: formatMoney(avg) },
            resultados: processed
        });
    }

    function loadInputs() {
        // Prioridad: URL > localStorage > DEFAULTS
        if (Object.keys(SERVER_PARAMS).length > 0) {
             const d = Object.assign({}, DEFAULTS, SERVER_PARAMS);
             for(const k in DEFAULTS) el.inputs[k].value = d[k];
             updateKwhHint();
             return;
        }
        let savedData = {};
        try { const r = localStorage.getItem(LS_KEY); if (r) savedData = JSON.parse(r); } catch(e){}
        const finalData = { ...DEFAULTS, ...savedData };
        for (const k in DEFAULTS) el.inputs[k].value = finalData[k];
        updateKwhHint();
    }

    function saveInputs(){ 
      const d={}; 
      for(const k in DEFAULTS)d[k]=el.inputs[k].value; 
      try { localStorage.setItem(LS_KEY,JSON.stringify(d)); } catch(e){} 
      return d; 
    }

    function resetInputs(){ 
      for(const k in DEFAULTS)el.inputs[k].value=DEFAULTS[k]; 
      saveInputs(); 
      updateKwhHint(); 
      clearErrorStyles(); 
      toast('Restablecido'); 
      setTimeout(()=>calculate(false), 300); 
    }

    function updateKwhHint(){ 
      const t=parseNum(el.inputs.cPunta.value)+parseNum(el.inputs.cLlano.value)+parseNum(el.inputs.cValle.value); 
      el.kwhHint.textContent=`${t.toFixed(2).replace('.',',')} kWh`; 
    }

    function clearErrorStyles(){ Object.values(el.inputs).forEach(i=>i.classList.remove('error')); }

    function rowTipoBadge(t){ 
      const s=String(t||'').trim(); 
      if(s==='1P')return `<span class="badge b1">1P</span>`; 
      if(s==='3P')return `<span class="badge b3">3P</span>`; 
      return `<span class="badge">${escapeHtml(s||'‚Äî')}</span>`; 
    }

    function formatVsWithBar(v,vn){ 
      const s=String(v??'').trim(); 
      if(!s||s==='‚Äî'||s==='0'||s==='0,00'||s==='0 ‚Ç¨'||s==='0,00 ‚Ç¨')return '<span class="vs-text zero">‚Äî</span>'; 
      const pos=s.startsWith('+'); 
      const c=pos?'pos':'neg'; 
      const a=pos?'‚ñ≤':'‚ñº'; 
      return `<span class="vs-text ${c}">${a} ${escapeHtml(s)}</span>`; 
    }

    function applyFilters(r){ 
      const f=state.filter; 
      return r.filter(x=>(f==='all'||String(x.tipo||'')===f)); 
    }

    function applySort(r){
      const {key,dir}=state.sort;
      const asc=dir==='asc';
      const c=r.slice();
      c.sort((a,b)=>{const va=a[key],vb=b[key];
        if(key==='nombre'){const sa=String(va||'').toLowerCase(),sb=String(vb||'').toLowerCase();if(sa>sb)return asc?1:-1;if(sa<sb)return asc?-1:1;return 0;}
        const na=Number(va)||0,nb=Number(vb)||0;
        if(na>nb)return asc?1:-1;if(na<nb)return asc?-1:1;return 0;
      });
      return c;
    }

    function updateSortIcons(){
      ['nombre','potenciaNum','consumoNum','impuestosNum','totalNum','vsMejorNum'].forEach(k=>{const i=$('si_'+k); if(!i)return; if(state.sort.key!==k){i.textContent='';return;} i.textContent=state.sort.dir==='asc'?'‚ñ≤':'‚ñº';});
    }

    function createRipple(b,e){ 
      const r=document.createElement('span'); 
      const rect=b.getBoundingClientRect(); 
      const s=Math.max(rect.width,rect.height); 
      const x=e.clientX-rect.left-s/2; 
      const y=e.clientY-rect.top-s/2; 
      r.style.cssText=`position:absolute;width:${s}px;height:${s}px;border-radius:50%;background:rgba(255,255,255,.4);left:${x}px;top:${y}px;pointer-events:none;animation:ripple 0.6s ease-out;`; 
      b.style.position='relative'; 
      b.style.overflow='hidden'; 
      b.appendChild(r); 
      setTimeout(()=>r.remove(),600); 
    }
    
    function renderTable(){
      const f = applyFilters(state.rows);
      const s = applySort(f);

      if (s.length === 0) {
        el.tbody.replaceChildren();
        el.table.classList.remove('show');
        el.emptyBox.classList.add('show');
        return;
      }

      requestAnimationFrame(() => {
        el.emptyBox.classList.remove('show');
        el.table.classList.add('show');

        const frag = document.createDocumentFragment();
        s.forEach((r, i) => {
          const tr = document.createElement('tr');
          if (r.esMejor) tr.classList.add('best');
          const w = r.webUrl
            ? `<a class="web" href="${escapeHtml(r.webUrl)}" target="_blank" rel="noopener" title="Abrir web">üîó</a>`
            : '';
          tr.innerHTML = `<td>${escapeHtml(r.posicion)}</td><td title="${escapeHtml(r.nombre)}">${escapeHtml(r.nombre)}</td><td>${escapeHtml(r.potencia)}</td><td>${escapeHtml(r.consumo)}</td><td>${escapeHtml(r.impuestos)}</td><td><strong style="font-weight:1100; color: rgba(167,139,250,1);">${escapeHtml(r.total)}</strong></td><td class="vs">${formatVsWithBar(r.vsMejor,r.vsMejorNum)}</td><td>${rowTipoBadge(r.tipo)}</td><td style="text-align:center">${w}</td>`;
          frag.appendChild(tr);
        });

        el.tbody.replaceChildren(frag);
        updateSortIcons();
      });
    }

    function renderTopChart() {
      const c = document.getElementById('chartTop');
      const body = document.getElementById('chartTopBody');
      if (!c || !body) return;

      const rows = state.rows || [];
      if (!rows.length) {
        c.classList.remove('show');
        body.innerHTML = '';
        return;
      }

      // Top 5 ordenadas por totalNum ascendente
      const sorted = rows
        .slice()
        .sort((a, b) => a.totalNum - b.totalNum)
        .slice(0, 5);

      const max = sorted[sorted.length - 1].totalNum || 1;

      const frag = document.createDocumentFragment();
      sorted.forEach((r, idx) => {
        const row = document.createElement('div');
        row.className = 'chartTop-row';
        if (idx === 0) row.classList.add('best');

        const pct = Math.max(5, Math.round((r.totalNum / max) * 100));

        row.innerHTML = `
      <div class="chartTop-name" title="${escapeHtml(r.nombre)}">
        ${escapeHtml(r.nombre)}
      </div>
      <div class="chartTop-barTrack">
        <div class="chartTop-barFill" data-width="${pct}%"></div>
      </div>
      <div class="chartTop-value">${escapeHtml(r.total || '')}</div>
    `;

        frag.appendChild(row);
      });

      body.replaceChildren(frag);
      c.classList.add('show');

      // Animaci√≥n de barras despu√©s de estar en el DOM
      requestAnimationFrame(() => {
        body.querySelectorAll('.chartTop-barFill').forEach(bar => {
          const w = bar.getAttribute('data-width') || '0%';
          bar.style.width = w;
        });
      });
    }

    function renderAll(d){
        if(!d||!d.success){setStatus('Error de c√°lculo','err');toast('Error al calcular','err');return;}
        setStatus('Resultados actualizados','ok'); 
        const r=d.resumen||{}; 
        if(r.mejor) el.kpiBest.textContent=r.mejor;
        if(r.precio) el.kpiPrice.textContent=r.precio;
        el.heroKpis.classList.add('show');
        const s=d.stats;
        if(s){ el.statMin.textContent=s.precioMin; el.statAvg.textContent=s.precioMedio; el.statMax.textContent=s.precioMax; el.statsBar.classList.add('show'); }
        state.rows=Array.isArray(d.resultados)?d.resultados:[];
        el.toolbar.classList.add('show');
        renderTopChart();
        renderTable();
        if(window.innerWidth<1100){
          const sb=$('scrollToResults');
          sb.style.display='block';
          setTimeout(()=>sb.style.display='none',5000); 
        }
    }

    function scheduleCalculateDebounced(){
      clearTimeout(state.debounce);
      state.debounce = setTimeout(()=>calculate(false, false), 500);
    }

    async function calculate(isUserAction, forceRefresh = false){
        const values = getInputValues();
        const signature = signatureFromValues(values);

        if(!forceRefresh && state.lastSignature === signature){
          setStatus('Listo para calcular', 'idle');
          return;
        }

        saveInputs();
        setStatus('Calculando...', 'loading');
        const loaded = await fetchTarifas(forceRefresh);
        if(!loaded) return;
        calculateLocal(values);
        state.lastSignature = signature;
    }

    function toggleMenu(force){ 
      const s=(typeof force==='boolean')?force:!el.menuPanel.classList.contains('show'); 
      el.menuPanel.classList.toggle('show',s); 
      el.btnMenu.setAttribute('aria-expanded',s?'true':'false'); 
    }
    
    document.addEventListener('DOMContentLoaded', async ()=>{
      initTooltips();
      loadInputs();

      // C√°lculo inicial autom√°tico con los datos precargados
      calculate(false, true);

      Object.values(el.inputs).forEach(i=>{
          i.addEventListener('input',()=>{
              updateKwhHint();
              scheduleCalculateDebounced();
          });
      });

      document.querySelectorAll('.fbtn').forEach(b=>{
        b.addEventListener('click',(e)=>{
          createRipple(b,e);
          document.querySelectorAll('.fbtn').forEach(x=>x.classList.remove('active'));
          b.classList.add('active');
          state.filter=b.getAttribute('data-filter');
          renderTable();
        });
      });

      document.querySelectorAll('thead th.sort').forEach(th=>{
        th.addEventListener('click',()=>{
          const k=th.getAttribute('data-sort');
          if(!k)return;
          if(state.sort.key===k)state.sort.dir=(state.sort.dir==='asc')?'desc':'asc';
          else{state.sort.key=k;state.sort.dir='asc';}
          renderTable();updateSortIcons();
        });
      });

      el.btnCalc.addEventListener('click',(e)=>{
        createRipple(el.btnCalc,e);
        calculate(true, true);
      });

      el.btnMenu.addEventListener('click',(e)=>{
        createRipple(el.btnMenu,e);
        e.stopPropagation();
        toggleMenu();
      });

      el.menuPanel.addEventListener('click',(e)=>e.stopPropagation());
      document.addEventListener('click',()=>toggleMenu(false));
      document.addEventListener('keydown',(e)=>{if(e.key==='Escape')toggleMenu(false);});

      el.btnReset.addEventListener('click',(e)=>{
        createRipple(el.btnReset,e);
        toggleMenu(false);
        resetInputs();
      });

      el.btnExport.addEventListener('click',(e)=>{
          createRipple(el.btnExport,e);
          toggleMenu(false);
          if(!state.rows || state.rows.length === 0){ toast('No hay datos para descargar','err'); return; }
          const headers = ['#','Tarifa','Potencia','Consumo','Impuestos','Total','Vs Mejor','Tipo','Web'];
          const rows = state.rows.map(r=>[r.posicion,r.nombre,r.potencia,r.consumo,r.impuestos,r.total,r.vsMejor,r.tipo,r.webUrl||'']);
          const csv = [headers, ...rows].map(r=>r.join(';')).join('\n');
          const BOM = '\uFEFF';
          const blob = new Blob([BOM + csv], {type:'text/csv;charset=utf-8;'});
          const link = document.createElement('a');
          const url = URL.createObjectURL(blob);
          link.setAttribute('href',url);
          link.setAttribute('download',`ranking_tarifas_${new Date().toISOString().split('T')[0]}.csv`);
          link.style.visibility='hidden';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          toast('Ranking descargado');
      });

      el.btnShare.addEventListener('click', async (e) => {
        createRipple(el.btnShare,e);
        toggleMenu(false);

        const d = saveInputs();
        const qp = new URLSearchParams(d).toString();
        const url = `${window.location.origin}${window.location.pathname}?${qp}`;
        await copyText(url);
        toast('Enlace copiado al portapapeles');
      });

      $('scrollToResults').addEventListener('click',()=>$('heroKpis').scrollIntoView({behavior:'smooth',block:'start'}));
    });
  </script>
  <!-- Cloudflare Web Analytics -->
  <script defer src='https://static.cloudflareinsights.com/beacon.min.js' data-cf-beacon='{"token": "fea4a7fbe6e34ab1a867cff1c7837aa3"}'></script>
  <!-- End Cloudflare Web Analytics -->
</body>
</html>
