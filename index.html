<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Comparador profesional de tarifas el√©ctricas. Encuentra la luz m√°s barata en segundos." />
  <title>‚ö° Comparador de Tarifas El√©ctricas</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
  <link rel="icon" type="image/svg+xml" href="favicon.svg">

  <style>
    /* === TU DISE√ëO PRO ORIGINAL (Intacto) === */
    :root{
      --bg0:#070A12; --bg1:#0B1020; --card: rgba(255,255,255,.06); --card2: rgba(255,255,255,.085);
      --border: rgba(255,255,255,.10); --border2: rgba(255,255,255,.16); --text:#F7F7FB;
      --muted: rgba(247,247,251,.72); --muted2: rgba(247,247,251,.55);
      --accent:#8B5CF6; --accent2:#22C55E; --warn:#F59E0B; --danger:#EF4444;
      --shadow: 0 22px 65px rgba(0,0,0,.52); --shadow2: 0 16px 40px rgba(0,0,0,.50);
      --radius: 18px; --sans: 'Outfit', sans-serif; --mono: monospace;
    }
    *{box-sizing:border-box; margin:0; padding:0}
    html,body{height:100%;}
    body{ font-family: var(--sans); color: var(--text); background: radial-gradient(1000px 600px at 12% 15%, rgba(139,92,246,.22), transparent 55%), radial-gradient(1000px 680px at 86% 88%, rgba(34,197,94,.16), transparent 55%), linear-gradient(135deg, var(--bg0), var(--bg1)); overflow-x:hidden; }
    .container{ max-width:1400px; margin:0 auto; padding: clamp(50px, 5vw, 70px) clamp(22px, 4.5vw, 60px); }
    .topbar{ display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom: 22px; }
    .brand{display:flex; align-items:center; gap:14px; min-width: 240px; position: relative;}
    .logo{ width:60px; height:60px; border-radius:18px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display:grid; place-items:center; font-size: 32px; box-shadow: 0 0 30px rgba(139,92,246,.4); border: 2px solid rgba(255,255,255,.2); position:relative; overflow:visible; }
    .logo::before{ content:''; position:absolute; top:-50%; left:-50%; width:200%; height:200%; background:linear-gradient(45deg,transparent,rgba(255,255,255,.8),transparent); animation:logoRotate 3s linear infinite; }
    @keyframes logoRotate { from{transform:rotate(0deg)} to{transform:rotate(360deg)} }
    .logo:hover{ transform: scale(1.1) rotate(5deg); transition: 0.3s; }
    .particle{ position: absolute; width: 4px; height: 4px; background: linear-gradient(45deg, var(--accent), var(--accent2)); border-radius: 50%; opacity: 0; animation: particleFloat 3s infinite; }
    .particle:nth-child(1) { top: 10px; left: -20px; animation-delay: 0s; } .particle:nth-child(2) { top: 40px; left: -15px; animation-delay: 0.5s; } .particle:nth-child(3) { top: 25px; left: 80px; animation-delay: 1s; } 
    @keyframes particleFloat { 0% { opacity: 0; transform: translateY(0) scale(0); } 50% { opacity: 1; } 100% { opacity: 0; transform: translateY(-50px) scale(0); } }
    .brand h1{ font-size: clamp(20px,3.2vw,34px); font-weight: 900; background: linear-gradient(90deg, #a78bfa, #8b5cf6, #22c55e); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .brand p{color: var(--muted); font-size: 13px; margin-top: 3px;}
    .actions{display:flex; align-items:center; gap:10px; flex-wrap:wrap; justify-content:flex-end;}
    .pill{ padding: 10px 14px; background: var(--card); border: 1px solid var(--border); border-radius: 999px; font-size: 13px; color: var(--muted); display:flex; gap:8px; align-items:center; }
    .pill.ok{ border-color: rgba(34,197,94,.5); color: #fff; }
    .pill.loading{ border-color: rgba(139,92,246,.5); animation: pulse 1.5s infinite; }
    @keyframes pulse { 0%{opacity:1} 50%{opacity:.6} 100%{opacity:1} }
    .btn{ border: 1px solid var(--border); background: var(--card); color: var(--text); padding: 10px 12px; border-radius: 12px; cursor:pointer; font-weight: 900; font-size: 13px; transition: 0.2s; min-height: 44px; display:inline-flex; align-items:center; gap:10px; }
    .btn:hover{ background: var(--card2); border-color: var(--border2); transform: translateY(-2px); }
    .btn.primary{ background: linear-gradient(45deg, var(--accent), #6366f1); border-color: rgba(139,92,246,.5); box-shadow: 0 10px 30px rgba(139,92,246,.3); position:relative; overflow:hidden; }
    .btn.primary::before{ content:''; position:absolute; left:0; bottom:0; width:0%; height:3px; background:#fff; transition:0.3s; }
    .btn.primary.calculating::before{ width:100%; }
    .grid{ display:grid; grid-template-columns: 420px 1fr; gap: 24px; }
    @media (max-width: 1100px){ .grid{grid-template-columns:1fr;} }
    .card{ background: var(--card); border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow); backdrop-filter: blur(20px); overflow:hidden; animation: fadeInUp 0.5s ease-out; }
    .card .head{ padding: 18px; border-bottom: 1px solid var(--border); background: linear-gradient(180deg, rgba(139,92,246,.1), transparent); }
    .kicker{ font-size: 11px; letter-spacing: 1.2px; text-transform: uppercase; color: var(--muted2); font-weight: 900; }
    .title{ margin-top:6px; font-size: 18px; font-weight: 900; }
    .body{padding: 18px;}
    .alert{ border: 1px solid rgba(239,68,68,.4); background: rgba(239,68,68,.15); color: #fff; padding: 12px; border-radius: 12px; font-size: 13px; display:none; margin-bottom:12px; }
    .alert.show{ display:block; animation: shake 0.4s; }
    @keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-5px)} 75%{transform:translateX(5px)} }
    .form{ display:grid; grid-template-columns: repeat(3, 1fr); gap: 12px; }
    .group{display:flex; flex-direction:column; gap: 7px;}
    label{ font-size: 12px; color: var(--muted); font-weight: 900; }
    .input{ width:100%; padding: 14px 12px; border-radius: 12px; border: 1px solid var(--border); background: rgba(0,0,0,.22); color: var(--text); font-weight: 900; font-size: 15px; outline:none; transition:0.2s; }
    .input:focus{ border-color: var(--accent); box-shadow: 0 0 0 2px rgba(139,92,246,.2); }
    .row{ display:flex; gap: 12px; align-items:center; justify-content: space-between; margin-top: 14px; }
    .kwhPill{ padding: 10px 12px; border-radius: 14px; border: 1px solid var(--border); background: rgba(0,0,0,.18); font-family: var(--mono); font-weight: 1000; font-size: 16px; color:#fff; }
    .heroKpis{ display:grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 18px; }
    .heroCard{ padding: 18px; border-radius: 18px; border: 1px solid var(--border); background: linear-gradient(135deg, rgba(139,92,246,.1), rgba(34,197,94,.05)); display:flex; flex-direction:column; gap:8px; animation:fadeInUp 0.5s; }
    .heroCard.best{ border-color: rgba(251,191,36,.5); background: linear-gradient(135deg, rgba(251,191,36,.15), rgba(139,92,246,.1)); position:relative; overflow:hidden; }
    .heroCard.best::after{ content:''; position:absolute; top:0; left:-100%; width:100%; height:100%; background:linear-gradient(90deg,transparent,rgba(255,255,255,.1),transparent); animation:shine 3s infinite; }
    @keyframes shine{ 0%{left:-100%} 50%,100%{left:200%} }
    .heroCard .v{ font-size: clamp(28px,2.5vw,40px); font-weight: 900; letter-spacing: -1px; color:#fff; }
    .heroCard .k{ font-size: 11px; text-transform: uppercase; color: var(--muted); font-weight: 900; display:flex; align-items:center; gap:6px; }
    .tableWrap{ overflow-x: auto; margin-top:20px; }
    table{ width: 100%; border-collapse: separate; border-spacing: 0 8px; }
    tbody tr { background: rgba(255,255,255,.03); transition: 0.2s; cursor:default; }
    tbody tr:hover { transform: scale(1.01); background: rgba(255,255,255,.07); box-shadow: 0 10px 30px rgba(0,0,0,.3); }
    tbody tr.best { border:1px solid rgba(251,191,36,.3); background: linear-gradient(90deg, rgba(251,191,36,.05), transparent); }
    td, th { padding: 12px; text-align: right; color: var(--text); border:none; white-space:nowrap; }
    td:first-child{ border-radius: 12px 0 0 12px; text-align:center; color: var(--muted); }
    td:last-child{ border-radius: 0 12px 12px 0; }
    th{ text-align: right; color: var(--muted); font-size: 11px; text-transform: uppercase; letter-spacing: 1px; }
    th:first-child{ text-align:center; }
    th:nth-child(2), td:nth-child(2){ text-align:left; font-weight: 700; color: #fff; font-size:15px; }
    .badge{ padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 900; background: rgba(255,255,255,.1); }
    .badge.b1{ background: rgba(59,130,246,.3); color: #93c5fd; }
    .badge.b3{ background: rgba(245,158,11,.3); color: #fcd34d; }
    .scroll-btn{ position:fixed; bottom:30px; right:30px; padding:12px 20px; border-radius:50px; background:var(--accent); border:none; color:white; font-weight:900; cursor:pointer; box-shadow:0 10px 30px rgba(139,92,246,.5); z-index:100; animation: bounce 2s infinite; }
    @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    @media(max-width:768px){ 
        thead{display:none} 
        tbody tr{display:block; margin-bottom:15px; border:1px solid var(--border); padding:15px; border-radius:16px;}
        tbody td{display:flex; justify-content:space-between; text-align:right; width:100%; border-bottom:1px solid rgba(255,255,255,.05); padding:10px 0;}
        tbody td:last-child{border:none}
        tbody td:nth-child(2){font-size:18px; text-align:center; display:block; margin-bottom:10px; border-bottom:2px solid var(--border);}
        tbody td:before{content:attr(data-label); color:var(--muted); font-weight:700; font-size:12px;}
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="topbar">
      <div class="brand">
        <span class="particle"></span><span class="particle"></span><span class="particle"></span>
        <div class="logo">‚ö°</div>
        <div><h1>Comparador</h1><p>Encuentra la mejor tarifa</p></div>
      </div>
      <div class="actions">
        <div class="pill" id="status"><span id="statusDot">‚óè</span> <span id="statusText">Listo</span></div>
        <button class="btn" id="btnReset">‚Ü∫</button>
      </div>
    </div>

    <div class="grid">
      <section class="card">
        <div class="head"><div class="kicker">TUS DATOS</div><div class="title">Potencia y consumos</div></div>
        <div class="body">
          <div class="alert" id="errorBox"></div>
          <div class="form">
            <div class="group"><label>Potencia P1 (kW)</label><input id="p1" class="input" type="number" step="0.01"></div>
            <div class="group"><label>Potencia P2 (kW)</label><input id="p2" class="input" type="number" step="0.01"></div>
            <div class="group"><label>D√≠as factura</label><input id="dias" class="input" type="number"></div>
          </div>
          <div style="height:15px"></div>
          <div class="form">
            <div class="group"><label>Consumo PUNTA</label><input id="cPunta" class="input" type="number"></div>
            <div class="group"><label>Consumo LLANO</label><input id="cLlano" class="input" type="number"></div>
            <div class="group"><label>Consumo VALLE</label><input id="cValle" class="input" type="number"></div>
          </div>
          <div class="row">
            <div class="kwhPill" id="kwhTotal">0 kWh</div>
            <button class="btn primary" id="btnCalc">‚ö° Calcular</button>
          </div>
        </div>
      </section>

      <section class="card">
        <div class="head"><div class="kicker">RESULTADOS</div><div class="title">Ranking de precios</div></div>
        <div class="body">
          <div class="heroKpis" id="heroKpis" style="display:none">
            <div class="heroCard best"><div class="k">üèÜ MEJOR OPCI√ìN</div><div class="v" id="bestName">---</div></div>
            <div class="heroCard"><div class="k">FACTURA MENSUAL</div><div class="v" id="bestPrice">---</div></div>
          </div>
          <div class="tableWrap">
            <table id="table" style="display:none">
              <thead><tr><th>#</th><th>Compa√±√≠a</th><th>Potencia</th><th>Consumo</th><th>Impuestos</th><th>TOTAL</th><th>Tipo</th></tr></thead>
              <tbody id="tbody"></tbody>
            </table>
            <div id="empty" style="padding:40px; text-align:center; color:var(--muted);">
              Calculando ofertas disponibles...
            </div>
          </div>
        </div>
      </section>
    </div>
    <button id="scrollBtn" class="scroll-btn" style="display:none">‚Üì Ver Resultados</button>
  </div>

  <script>
    const $ = id => document.getElementById(id);
    
    // URL DE TU SCRIPT DE GOOGLE (CORRECTA)
    const API_URL = 'https://script.google.com/macros/s/AKfycbwfrP2AxSQz_k1NlSDcdZxvQR_m0t3xKO1JnD7FnRqOWCM0RYqLihg5cca6vXQswn4j/exec';

    // CLAVE DE ALMACENAMIENTO Y VALORES POR DEFECTO
    const LS_KEY = 'almax_data_v8';
    const LS_TOKEN = 'almax_token';
    const DEFAULTS = { p1:3.45, p2:3.45, dias:30, cPunta:100, cLlano:100, cValle:100 };
    
    // ELEMENTOS
    const inputs = {
      p1: $('p1'), p2: $('p2'), dias: $('dias'),
      cPunta: $('cPunta'), cLlano: $('cLlano'), cValle: $('cValle')
    };

    let tarifasCache = [];
    let logTimeout = null;

    // --- INICIO ---
    document.addEventListener('DOMContentLoaded', async () => {
      // 1. Cargar Tarifas (Segundo plano)
      fetchTarifas();

      // 2. Cargar Inputs (Gesti√≥n de vac√≠os/cookies)
      loadInputs();

      // 3. Listeners
      for(const k in inputs){
        inputs[k].addEventListener('input', () => {
          updateTotal();
          scheduleCalc();
          saveInputs();
        });
      }
      
      $('btnCalc').addEventListener('click', () => calculate());
      $('btnReset').addEventListener('click', resetInputs);
      $('scrollBtn').addEventListener('click', () => $('heroKpis').scrollIntoView({behavior:'smooth'}));
      
      // 4. Auto-calcular si hay datos
      setTimeout(() => { if(inputs.p1.value) calculate(); }, 800);
    });

    // --- CARGA DE DATOS INTELIGENTE ---
    function loadInputs() {
      // Prioridad 1: URL Params (Enlaces compartidos)
      const params = new URLSearchParams(location.search);
      let fromUrl = false;
      for(const k in DEFAULTS) {
        if(params.has(k)) { inputs[k].value = params.get(k); fromUrl = true; }
      }
      
      if(!fromUrl) {
        // Prioridad 2: LocalStorage (Memoria)
        let saved = null;
        try { saved = JSON.parse(localStorage.getItem(LS_KEY)); } catch(e){}
        
        // Prioridad 3: DEFAULTS (Si es nuevo o borr√≥ cookies)
        // Usamos spread para mezclar: Defaults se sobreescriben con Saved si existen
        const data = { ...DEFAULTS, ...saved };
        
        for(const k in DEFAULTS) inputs[k].value = data[k];
      }
      updateTotal();
    }

    function saveInputs() {
      const d = {};
      for(const k in inputs) d[k] = inputs[k].value;
      localStorage.setItem(LS_KEY, JSON.stringify(d));
    }

    function resetInputs() {
      localStorage.removeItem(LS_KEY);
      location.reload(); // Recarga limpia
    }

    // --- MOTOR DE C√ÅLCULO ---
    async function fetchTarifas() {
      try {
        const res = await fetch(API_URL + '?action=tarifas');
        const data = await res.json();
        if(data.success) {
          tarifasCache = data.tarifas;
          $('statusText').innerText = "Datos actualizados";
          $('status').classList.add('ok');
        }
      } catch(e) { console.error("Error tarifas", e); }
    }

    function calculate() {
      if(!tarifasCache.length) return;
      $('btnCalc').classList.add('calculating');
      
      // Obtener valores (o defaults si campo vac√≠o)
      const d = {};
      for(const k in inputs) d[k] = parseFloat(inputs[k].value) || 0;

      const resultados = tarifasCache.map(t => {
        // F√≥rmulas exactas Excel
        const pot = (d.p1 * d.dias * t.p1) + (d.p2 * d.dias * t.p2);
        const cons = (d.cPunta * t.cPunta) + (d.cLlano * t.cLlano) + (d.cValle * t.cValle);
        const acceso = (4.650987 / 365 * d.dias);
        const base = pot + cons + acceso;
        const imp = Math.max(base * 0.051127, (d.cPunta + d.cLlano + d.cValle) * 0.001);
        const margen = d.dias * 0.026667;
        const sub = base + imp + margen;
        const total = sub * 1.21;

        return { ...t, total, detalles: {pot, cons, imp: imp+margen+(sub*0.21)} };
      }).sort((a,b) => a.total - b.total);

      render(resultados);
      
      // ENVIAR LOG (Con Token)
      logToGoogle(resultados[0], d);
      
      setTimeout(()=> $('btnCalc').classList.remove('calculating'), 300);
    }

    function render(res) {
      $('empty').style.display='none';
      $('heroKpis').style.display='grid';
      $('table').style.display='table';
      
      const best = res[0];
      $('bestName').innerText = best.nombre;
      $('bestPrice').innerText = fmt(best.total);

      $('tbody').innerHTML = res.map((r,i) => `
        <tr class="${i===0?'best':''}">
          <td>${i+1}</td>
          <td data-label="Compa√±√≠a">${r.nombre}</td>
          <td data-label="Potencia">${fmt(r.detalles.pot)}</td>
          <td data-label="Consumo">${fmt(r.detalles.cons)}</td>
          <td data-label="Impuestos">${fmt(r.detalles.imp)}</td>
          <td data-label="TOTAL" style="font-weight:900; font-size:1.1em; color:${i===0?'#fbbf24':'#fff'}">${fmt(r.total)}</td>
          <td data-label="Tipo"><span class="badge ${r.tipo==='1P'?'b1':'b3'}">${r.tipo}</span></td>
        </tr>
      `).join('');
      
      if(window.innerWidth < 768) $('scrollBtn').style.display='block';
    }

    // --- LOGGING Y HELPERS ---
    function logToGoogle(best, d) {
      clearTimeout(logTimeout);
      logTimeout = setTimeout(() => {
        let token = localStorage.getItem(LS_TOKEN);
        if(!token) { token = 'u_' + Date.now() + '_' + Math.random().toString(36).substr(2,6); localStorage.setItem(LS_TOKEN, token); }

        const q = new URLSearchParams();
        q.append('action', 'log');
        q.append('token', token); // AHORA S√ç MANDA EL TOKEN
        q.append('p1', d.p1); q.append('p2', d.p2); q.append('dias', d.dias);
        q.append('cPunta', d.cPunta); q.append('cLlano', d.cLlano); q.append('cValle', d.cValle);
        q.append('totalKwh', d.cPunta+d.cLlano+d.cValle);
        q.append('mejorTarifa', best.nombre);
        q.append('mejorPrecio', best.total.toFixed(2));
        q.append('dispositivo', window.innerWidth < 768 ? 'Mobile' : 'Desktop');

        fetch(API_URL + '?' + q.toString(), { mode: 'no-cors' });
      }, 3000);
    }

    let debounceTimer;
    function scheduleCalc() { clearTimeout(debounceTimer); debounceTimer = setTimeout(calculate, 500); }
    function updateTotal() { 
      const sum = (parseFloat(inputs.cPunta.value)||0) + (parseFloat(inputs.cLlano.value)||0) + (parseFloat(inputs.cValle.value)||0);
      $('kwhTotal').innerText = sum.toFixed(0) + ' kWh';
    }
    function fmt(n) { return n.toFixed(2).replace('.', ',') + ' ‚Ç¨'; }
  </script>
</body>
</html>
