<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comparador de Tarifas Eléctricas - LuzFija.es</title>
    <meta name="description" content="Comparador de tarifas de luz rápido y gratuito. Encuentra la mejor tarifa eléctrica en segundos.">
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <style>
        :root {
            --bg-dark: #1a1a2e;
            --bg-panel: rgba(255, 255, 255, 0.05);
            --primary: #667eea;
            --secondary: #764ba2;
            --text-main: #e0e0e0;
            --text-dim: #888;
            --success: #4ade80;
            --accent: #ff6b6b;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--bg-dark) 0%, #16213e 100%);
            color: var(--text-main);
            min-height: 100vh;
            padding: 20px;
            line-height: 1.6;
        }

        .container { max-width: 1200px; margin: 0 auto; }

        /* Header */
        header { text-align: center; margin-bottom: 40px; padding-top: 20px; }
        .logo { 
            font-size: 3rem; 
            margin-bottom: 10px; 
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 800;
        }
        .tagline { color: var(--text-dim); font-size: 1.1rem; }

        /* Layout Main */
        .main-grid {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 30px;
        }

        /* Panel Styles */
        .panel {
            background: var(--bg-panel);
            border: 1px solid rgba(102, 126, 234, 0.2);
            border-radius: 16px;
            padding: 25px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        h2 { margin-bottom: 20px; font-size: 1.2rem; color: #fff; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; }

        /* Inputs */
        .input-group { margin-bottom: 20px; }
        label { display: block; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text-dim); margin-bottom: 8px; font-weight: 600; }
        input {
            width: 100%;
            padding: 12px;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(102, 126, 234, 0.3);
            border-radius: 8px;
            color: #fff;
            font-size: 1rem;
            transition: 0.3s;
        }
        input:focus { outline: none; border-color: var(--primary); box-shadow: 0 0 15px rgba(102, 126, 234, 0.2); }

        /* Resultados */
        .loading-state { text-align: center; padding: 40px; color: var(--text-dim); font-style: italic; }
        
        /* Tarjeta Mejor Precio */
        .best-card {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            border: 2px solid var(--primary);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            margin-bottom: 30px;
            animation: fadeIn 0.5s ease-out;
        }
        .best-label { color: var(--success); font-weight: bold; text-transform: uppercase; font-size: 0.9rem; letter-spacing: 1px; margin-bottom: 5px; }
        .best-price { font-size: 3rem; font-weight: 800; color: #fff; line-height: 1; margin: 10px 0; }
        .best-name { font-size: 1.2rem; color: var(--text-dim); }

        /* Lista Ranking */
        .ranking-list { display: flex; flex-direction: column; gap: 10px; }
        .tariff-row {
            display: grid;
            grid-template-columns: 40px 1fr auto auto;
            align-items: center;
            padding: 15px;
            background: rgba(255,255,255,0.02);
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.05);
            gap: 15px;
            transition: 0.2s;
        }
        .tariff-row:hover { background: rgba(255,255,255,0.05); transform: translateX(5px); }
        .pos { font-weight: bold; color: var(--text-dim); }
        .t-name { font-weight: 600; color: #fff; }
        .t-price { font-weight: bold; color: var(--primary); font-size: 1.1rem; }
        .t-diff { font-size: 0.85rem; color: var(--accent); }
        .t-link a { color: var(--text-dim); text-decoration: none; font-size: 0.8rem; border: 1px solid rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 4px; }
        .t-link a:hover { background: white; color: black; }

        /* Estadísticas rápidas */
        .stats-row {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        .stat-box {
            background: rgba(0,0,0,0.2);
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-val { font-weight: bold; color: var(--primary); font-size: 1.1rem; }
        .stat-lbl { font-size: 0.7rem; color: var(--text-dim); text-transform: uppercase; }

        /* Responsive */
        @media (max-width: 768px) {
            .main-grid { grid-template-columns: 1fr; }
            .logo { font-size: 2.5rem; }
            .tariff-row { grid-template-columns: 30px 1fr auto; font-size: 0.9rem; }
            .t-diff { display: none; }
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="logo">⚡ LuzFija.es</div>
        <p class="tagline">Comparador de tarifas en tiempo real</p>
    </header>

    <div class="main-grid">
        <div class="panel input-panel">
            <h2>Tus Datos</h2>
            
            <div class="input-group">
                <label>Potencia P1 (kW)</label>
                <input type="number" id="p1" value="3.45" step="0.01">
            </div>
            <div class="input-group">
                <label>Potencia P2 (kW)</label>
                <input type="number" id="p2" value="3.45" step="0.01">
            </div>
            <div class="input-group">
                <label>Días Factura</label>
                <input type="number" id="dias" value="30" min="1">
            </div>
            
            <hr style="border: 0; border-top: 1px solid rgba(255,255,255,0.1); margin: 20px 0;">

            <div class="input-group">
                <label>Consumo Punta (kWh)</label>
                <input type="number" id="cPunta" value="100">
            </div>
            <div class="input-group">
                <label>Consumo Llano (kWh)</label>
                <input type="number" id="cLlano" value="100">
            </div>
            <div class="input-group">
                <label>Consumo Valle (kWh)</label>
                <input type="number" id="cValle" value="100">
            </div>

            <div class="stat-box" style="margin-top: 20px; background: rgba(102, 126, 234, 0.1); border: 1px solid var(--primary);">
                <div class="stat-lbl">Consumo Total</div>
                <div class="stat-val" id="totalKwhDisplay">300 kWh</div>
            </div>
        </div>

        <div class="panel results-panel">
            <h2>Resultados</h2>
            <div id="loading" class="loading-state">
                <p>⏳ Conectando con la base de datos de precios...</p>
            </div>
            
            <div id="results" style="display: none;">
                <div class="best-card">
                    <div class="best-label">⭐ Mejor Oferta</div>
                    <div class="best-name" id="bestName">Cargando...</div>
                    <div class="best-price" id="bestPrice">--- €</div>
                </div>

                <div class="stats-row">
                    <div class="stat-box">
                        <div class="stat-lbl">Media</div>
                        <div class="stat-val" id="avgPrice">--</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-lbl">Más cara</div>
                        <div class="stat-val" id="maxPrice">--</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-lbl">Ahorro est.</div>
                        <div class="stat-val" id="savingEst" style="color: var(--success)">--</div>
                    </div>
                </div>

                <div class="ranking-list" id="rankingList">
                    </div>
            </div>
        </div>
    </div>
</div>

<script>
    // CONFIGURACIÓN
    // URL EXACTA DE TU DEPLOY
    const API_URL = 'https://script.google.com/macros/s/AKfycbwfrP2AxSQz_k1NlSDcdZxvQR_m0t3xKO1JnD7FnRqOWCM0RYqLihg5cca6vXQswn4j/exec';

    // ESTADO
    let tarifasData = [];
    
    // ELEMENTOS DOM
    const inputs = ['p1', 'p2', 'dias', 'cPunta', 'cLlano', 'cValle'];

    // INICIO
    document.addEventListener('DOMContentLoaded', () => {
        fetchTarifas();
        setupListeners();
    });

    function setupListeners() {
        inputs.forEach(id => {
            document.getElementById(id).addEventListener('input', () => {
                updateTotalKwh();
                calcular();
            });
        });
    }

    function updateTotalKwh() {
        const sum = getVal('cPunta') + getVal('cLlano') + getVal('cValle');
        document.getElementById('totalKwhDisplay').textContent = sum.toFixed(0) + ' kWh';
    }

    async function fetchTarifas() {
        try {
            const response = await fetch(API_URL + '?action=tarifas');
            const data = await response.json();
            
            if (data.success) {
                tarifasData = data.tarifas;
                document.getElementById('loading').style.display = 'none';
                document.getElementById('results').style.display = 'block';
                calcular(); // Primer cálculo
            } else {
                throw new Error('Error en datos');
            }
        } catch (e) {
            document.getElementById('loading').innerHTML = 
                `<p style="color: #ff6b6b">❌ Error cargando tarifas. <br>Revisa tu conexión o intenta de nuevo.</p>`;
            console.error(e);
        }
    }

    function calcular() {
        if (!tarifasData.length) return;

        const p1 = getVal('p1');
        const p2 = getVal('p2');
        const dias = getVal('dias');
        const cPunta = getVal('cPunta');
        const cLlano = getVal('cLlano');
        const cValle = getVal('cValle');

        // CÁLCULO LOCAL (Réplica exacta de tu lógica Apps Script/Excel)
        const resultados = tarifasData.map(t => {
            // Potencia
            const pot = Math.round((p1 * dias * t.p1 + p2 * dias * t.p2) * 100) / 100;
            
            // Consumo
            const cons = Math.round((cPunta * t.cPunta + cLlano * t.cLlano + cValle * t.cValle) * 100) / 100;
            
            // Impuestos y fijos
            const tarifaAcceso = Math.round((4.650987 / 365 * dias) * 100) / 100;
            const sumaBase = pot + cons + tarifaAcceso;
            
            const impuestoElec = Math.round(Math.max(
                (5.11269632 / 100) * sumaBase,
                (cPunta + cLlano + cValle) * 0.001
            ) * 100) / 100;

            const margen = Math.round((dias * 0.026667) * 100) / 100;
            const subtotal = sumaBase + impuestoElec + margen;
            const iva = Math.round((subtotal * 0.21) * 100) / 100; // 21% IVA
            
            const total = Math.round((subtotal + iva) * 100) / 100;

            return { ...t, total };
        });

        // Ordenar
        resultados.sort((a, b) => a.total - b.total);
        renderResults(resultados);
    }

    function renderResults(resultados) {
        if(!resultados.length) return;
        
        const best = resultados[0];
        const worst = resultados[resultados.length - 1];
        const totalSum = resultados.reduce((acc, curr) => acc + curr.total, 0);
        const avg = totalSum / resultados.length;

        // Tarjeta Mejor Precio
        document.getElementById('bestName').textContent = best.nombre;
        document.getElementById('bestPrice').textContent = formatEuro(best.total);
        
        // Stats
        document.getElementById('avgPrice').textContent = formatEuro(avg);
        document.getElementById('maxPrice').textContent = formatEuro(worst.total);
        document.getElementById('savingEst').textContent = '-' + formatEuro(avg - best.total);

        // Tabla
        const listHtml = resultados.map((r, i) => {
            const diff = r.total - best.total;
            const diffText = i === 0 ? '---' : '+' + diff.toFixed(2).replace('.', ',') + '€';
            
            return `
            <div class="tariff-row">
                <div class="pos">${i + 1}</div>
                <div class="t-name">${r.nombre}</div>
                <div class="t-price">${formatEuro(r.total)}</div>
                <div class="t-diff">${diffText}</div>
            </div>
            `;
        }).join('');
        
        document.getElementById('rankingList').innerHTML = listHtml;
    }

    function getVal(id) {
        return parseFloat(document.getElementById(id).value) || 0;
    }

    function formatEuro(num) {
        return num.toFixed(2).replace('.', ',') + ' €';
    }
</script>

</body>
</html>
